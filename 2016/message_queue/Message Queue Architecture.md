#### 微服务架构中的消息队列

微服务时代来临，互联网应用逐渐由单体应用架构转变为分布式的微服务架构。各个微服务之间的消息通信有同步和异步之分，而微服务化使得同步调用不再具有低延时和高可用的特点。为了保证用户体验，我们不得不将部分同步操作转变为异步，使消息队列的设计在异步的消息架构中变得至关重要。

一起来探讨一下，我们如何保证消息准确送达？业界这么多消息队列框架，如何挑选最合适自己业务模型的？



#### Outline

---

##### 为什么大街小巷都在谈微服务？Why microservice?

因为：

1. 社会在不断向前发展
2. 业务容量迅速上升
3. 进行容量扩展
   * 垂直扩展（Scale Up）成本高昂，可预见的上限
   * 水平拓展（Scale Out）成本较为低廉
4. 水平拓展时
   * 单体应用（Monolithic）紧耦合，扩展的时候效率不按比例，粗犷
   * 微服务（Microservice）松耦合，细粒度，高效率


---

##### 解耦 Decoupling

解耦的过程：

* 是治疗重度洁癖和强迫症架构师的过程；
* 是将披萨分成一片一片的过程，却又享受地看着香浓芝士在其间相连的过程；
* 是将业务一步一步剥离开来，或把不那么核心的业务过程抛到外围的过程。

比如：


> 在老马家的 Web 端购买了一单商品后， 网页显示支付成功，App 在半分钟以后收到同样的消息推送。

> 

为了解耦，我们可以将一个业务流程分拆开来，每个部分由不同的线程或是服务来单独完成。

而要完成这个业务事件的传递，我们必须引入消息通信这个概念。

在这两种架构中，我们在某些业务场景下会有线程间（单体应用）或者服务间（微服务）的通信，这些通信根据业务的特性被分成同步和异步两种。



##### 同步和异步通信

同步形式的通信，即各种形态的 Remote Procedure Call：

* gRPC
* Thrift
* Dubbo

以及各种形式的序列化方法：

* JSON
* Protocol Buffer
* MessagePack



异步形式的通信：

* 消息队列
* 其它形式的消息的队列
  * 数据库
  * 文件







业务解耦/最终一致性/广播/错峰流控

反之，如果需要强一致性，关注业务逻辑的处理结果，则RPC显得更为合适。





ZeroMQ：





Broker vs. Brokerless

http://zeromq.org/whitepapers:brokerless

Dissecting Message Queues

http://bravenewgeek.com/dissecting-message-queues/



https://www.iron.io/top-10-uses-for-message-queue/